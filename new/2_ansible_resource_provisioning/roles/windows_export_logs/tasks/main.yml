--- 

# #todo
# - name: Get timestamp from the system
#   ansible.windows.win_shell: "Get-Date -Format 'dd-MM-yyyy-HH-mm'"
#   register: timestamp

# - name: Get hostname
#   ansible.windows.win_shell: "hostname"
#   register: hostname


#C:\Export-EventLogs\Export-EventLogs.ps1 -EventLogNames "Application","HardwareEvents","Internet Explorer","Key Management Service","Microsoft-Windows-AppHost/Admin","Microsoft-Windows-AppID/Operational","Microsoft-Windows-AppLocker/EXE and DLL","Microsoft-Windows-Authentication/AuthenticationPolicyFailures-DomainController","Microsoft-Windows-Authentication/ProtectedUser-Client","Microsoft-Windows-Authentication/ProtectedUserFailures-DomainController","Microsoft-Windows-Authentication/ProtectedUserSuccesses-DomainController","Microsoft-Windows-Authentication User Interface/Operational","Microsoft-Windows-BackgroundTaskInfrastructure/Operational","Microsoft-Windows-Base-Filtering-Engine-Connections/Operational","Microsoft-Windows-Base-Filtering-Engine-Resource-Flows/Operational","Microsoft-Windows-Bluetooth-BthLEPrepairing/Operational","Microsoft-Windows-Bluetooth-Bthmini/Operational","Microsoft-Windows-Bluetooth-MTPEnum/Operational","Microsoft-Windows-Bluetooth-Policy/Operational","Microsoft-Windows-BranchCacheSMB/Operational","Microsoft-Windows-CAPI2/Operational","Microsoft-Windows-CertificateServicesClient-CredentialRoaming/Operational","Microsoft-Windows-CertificateServicesClient-Lifecycle-System/Operational","Microsoft-Windows-CertificateServicesClient-Lifecycle-User/Operational","Microsoft-Windows-CertificateServices-Deployment/Operational","Microsoft-Windows-CertPoleEng/Operational","Microsoft-Windows-CloudStore/Operational","Microsoft-Windows-CodeIntegrity/Operational","Microsoft-Windows-CoreApplication/Operational","Microsoft-Windows-Crypto-DPAPI/BackUpKeySvc","Microsoft-Windows-Crypto-DPAPI/Debug","Microsoft-Windows-Crypto-DPAPI/Operational","Microsoft-Windows-Crypto-NCrypt/Operational","Microsoft-Windows-DateTimeControlPanel/Operational","Microsoft-Windows-DeviceGuard/Operational","Microsoft-Windows-Devices-Background/Operational","Microsoft-Windows-DeviceSetupManager/Admin","Microsoft-Windows-DeviceSetupManager/Operational","Microsoft-Windows-DeviceUpdateAgent/Operational","Microsoft-Windows-Dhcp-Client/Admin","Microsoft-Windows-Dhcp-Client/Operational","Microsoft-Windows-Dhcpv6-Client/Admin","Microsoft-Windows-Dhcpv6-Client/Operational","Microsoft-Windows-DirectoryServices-Deployment/Operational","Microsoft-Windows-DNS-Client/Operational","Microsoft-Windows-DriverFrameworks-UserMode/Operational","Microsoft-Windows-DSC/Admin","Microsoft-Windows-DSC/Operational","Microsoft-Windows-EapHost/Operational","Microsoft-Windows-EapMethods-RasChap/Operational","Microsoft-Windows-EapMethods-RasTls/Operational","Microsoft-Windows-EapMethods-Sim/Operational","Microsoft-Windows-EapMethods-Ttls/Operational","Microsoft-Windows-EventCollector/Operational","Microsoft-Windows-Fault-Tolerant-Heap/Operational","Microsoft-Windows-FeatureConfiguration/Operational","Microsoft-Windows-FederationServices-Deployment/Operational","Microsoft-Windows-FileServices-ServerManager-EventProvider/Admin","Microsoft-Windows-FileServices-ServerManager-EventProvider/Operational","Microsoft-Windows-FileShareShadowCopyProvider/Operational","Microsoft-Windows-FMS/Operational","Microsoft-Windows-Folder Redirection/Operational","Microsoft-Windows-Forwarding/Operational","Microsoft-Windows-glcnd/Admin","Microsoft-Windows-GroupPolicy/Operational","Microsoft-Windows-HttpService/Log","Microsoft-Windows-HttpService/Trace","Microsoft-Windows-IKE/Operational","Microsoft-Windows-KdsSvc/Operational","Microsoft-Windows-Kerberos-KdcProxy/Operational","Microsoft-Windows-Kerberos/Operational","Microsoft-Windows-Kernel-ApphelpCache/Operational","Microsoft-Windows-Kernel-Boot/Operational","Microsoft-Windows-Kernel-EventTracing/Admin","Microsoft-Windows-Kernel-IO/Operational","Microsoft-Windows-Kernel-PnP/Configuration","Microsoft-Windows-Kernel-Power/Thermal-Operational","Microsoft-Windows-Kernel-ShimEngine/Operational","Microsoft-Windows-Kernel-StoreMgr/Operational","Microsoft-Windows-Kernel-WDI/Operational","Microsoft-Windows-Kernel-WHEA/Errors","Microsoft-Windows-Kernel-WHEA/Operational","Microsoft-Windows-NCSI/Operational","Microsoft-Windows-NdisImPlatform/Operational","Microsoft-Windows-NDIS/Operational","Microsoft-Windows-NetworkLocationWizard/Operational","Microsoft-Windows-NetworkProfile/Operational","Microsoft-Windows-NetworkProvider/Operational","Microsoft-Windows-NlaSvc/Operational","Microsoft-Windows-Ntfs/Operational","Microsoft-Windows-Ntfs/WHC","Microsoft-Windows-NTLM/Operational","Microsoft-Windows-OtpCredentialProvider/Operational","Microsoft-Windows-Policy/Operational","Microsoft-Windows-PowerShell/Admin","Microsoft-Windows-PowerShell-DesiredStateConfiguration-FileDownloadManager/Operational","Microsoft-Windows-PowerShell/Operational","Microsoft-Windows-PrintBRM/Admin","Microsoft-Windows-PrintService/Admin","Microsoft-Windows-PrintService/Operational","Microsoft-Windows-Regsvr32/Operational","Microsoft-Windows-RemoteApp and Desktop Connections/Admin","Microsoft-Windows-RemoteApp and Desktop Connections/Operational","Microsoft-Windows-RemoteDesktopServices-RdpCoreTS/Admin","Microsoft-Windows-RemoteDesktopServices-RdpCoreTS/Operational","Microsoft-Windows-RemoteDesktopServices-RemoteFX-Synth3dvsc/Admin","Microsoft-Windows-RemoteDesktopServices-SessionServices/Operational","Microsoft-Windows-Remotefs-Rdbss/Operational","Microsoft-Windows-Resource-Exhaustion-Detector/Operational","Microsoft-Windows-Resource-Exhaustion-Resolver/Operational","Microsoft-Windows-RestartManager/Operational","Microsoft-Windows-Security-Adminless/Operational","Microsoft-Windows-Security-Audit-Configuration-Client/Operational","Microsoft-Windows-Security-EnterpriseData-FileRevocationManager/Operational","Microsoft-Windows-Security-ExchangeActiveSyncProvisioning/Operational","Microsoft-Windows-Security-IdentityListener/Operational","Microsoft-Windows-Security-LessPrivilegedAppContainer/Operational","Microsoft-Windows-SecurityMitigationsBroker/Admin","Microsoft-Windows-SecurityMitigationsBroker/Operational","Microsoft-Windows-Security-Mitigations/KernelMode","Microsoft-Windows-Security-Mitigations/UserMode","Microsoft-Windows-Security-Netlogon/Operational","Microsoft-Windows-Security-SPP-UX-GenuineCenter-Logging/Operational","Microsoft-Windows-Security-SPP-UX-Notifications/ActionCenter","Microsoft-Windows-Security-UserConsentVerifier/Audit","Microsoft-Windows-Shell-ConnectedAccountState/ActionCenter","Microsoft-Windows-Shell-Core/ActionCenter","Microsoft-Windows-Shell-Core/AppDefaults","Microsoft-Windows-Shell-Core/LogonTasksChannel","Microsoft-Windows-Shell-Core/Operational","Microsoft-Windows-SmbClient/Audit","Microsoft-Windows-SmbClient/Connectivity","Microsoft-Windows-SMBClient/Operational","Microsoft-Windows-SmbClient/Security","Microsoft-Windows-SMBDirect/Admin","Microsoft-Windows-SMBServer/Audit","Microsoft-Windows-SMBServer/Connectivity","Microsoft-Windows-SMBServer/Operational","Microsoft-Windows-SMBServer/Security","Microsoft-Windows-SMBWitnessClient/Admin","Microsoft-Windows-SMBWitnessClient/Informational","Microsoft-Windows-Storage-Disk/Admin","Microsoft-Windows-Storage-Disk/Operational","Microsoft-Windows-Sysmon/Operational","Microsoft-Windows-TaskScheduler/Maintenance","Microsoft-Windows-TaskScheduler/Operational","Microsoft-Windows-TCPIP/Operational","Microsoft-Windows-TerminalServices-LocalSessionManager/Operational","Microsoft-Windows-TerminalServices-PnPDevices/Admin","Microsoft-Windows-TerminalServices-PnPDevices/Operational","Microsoft-Windows-TerminalServices-Printers/Admin","Microsoft-Windows-TerminalServices-Printers/Operational","Microsoft-Windows-TerminalServices-RemoteConnectionManager/Admin","Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational"," Microsoft-Windows-Windows Defender/Operational","Microsoft-Windows-Windows Firewall With Advanced Security/Firewall","Microsoft-Windows-Windows Firewall With Advanced Security/FirewallVerbose","Microsoft-Windows-Winlogon/Operational"," Microsoft-Windows-WinNat/Oper","Microsoft-Windows-WinRM/Operational","Microsoft-Windows-WinRM/Operational","Microsoft-Windows-WMI-Activity/Operational","Network Isolation Operational","OAlerts","OpenSSH/Admin","OpenSSH/Operational","Security","Setup","System","Windows Powershell"
# todo: make cleaner by reading from file
# if output folder already exists and other files are already in there, folder is tainted. re-create
- name: collect logs
  ansible.windows.win_powershell:
    script: |
      If((Test-Path -Path "C:\Export-EventLogs\EventLogs\*"))
      {
        Remove-Item -Recurse -Force -LiteralPath "C:\Export-EventLogs\EventLogs\"
        New-Item -ItemType Directory -Force -Path C:\Export-EventLogs\EventLogs\
      }     

      cd C:\Export-EventLogs

      Get-Content -Path "C:\Export-EventLogs\selected_channels.txt" | ForEach-Object {
        .\Export-EventLogs.ps1 -EventLogNames $_
      }       

      Get-Content -Path "C:\Export-EventLogs\selected_channels.txt" | ForEach-Object {
        $filename = -join("C:\Export-EventLogs\EventLogs\", $_, "_tab.txt")
        $filename = $filename.Replace('/','-')
        Get-WinEvent -LogName $_ | Select-Object -Property KeywordDisplayName, TimeCreated, Source, ProviderName, Id, TaskDisplayName, LevelDisplayName, Message | Export-Csv -Path $filename -Delimiter "`t" -NoTypeInformation
      }

      Get-Content -Path "C:\Export-EventLogs\selected_channels.txt" | ForEach-Object {
        $filename = -join("C:\Export-EventLogs\EventLogs\", $_, "_comma.txt")
        $filename = $filename.Replace('/','-')
        Get-WinEvent -LogName $_ | Export-Csv -Path $filename -NoTypeInformation
      }      

      Copy-Item "C:\Windows\Logs\file_read.etl" -Destination "C:\Export-EventLogs\EventLogs"
      Copy-Item "C:\Windows\Logs\Registry_read.etl" -Destination "C:\Export-EventLogs\EventLogs"
      Copy-Item "C:\Windows\Logs\Powershell_payload.etl" -Destination "C:\Export-EventLogs\EventLogs"
      Copy-Item "C:\Windows\Logs\alpc.etl" -Destination "C:\Export-EventLogs\EventLogs"
      Copy-Item "C:\Windows\System32\winevt\Logs\powershell_audit.evtx" -Destination "C:\Export-EventLogs\EventLogs"
      Copy-Item "C:\Windows\System32\winevt\Logs\sysmon_audit.evtx" -Destination "C:\Export-EventLogs\EventLogs"

      Compress-Archive -Path "C:\Export-EventLogs\EventLogs\" -DestinationPath "C:\Export-EventLogs\{{ hostname }}_logs.zip"


- name: zip pcaps
  ansible.windows.win_powershell:
    script: |      
      Compress-Archive -Path "C:\Export-EventLogs\{{ hostname }}.pcapng" -DestinationPath "C:\Export-EventLogs\{{ hostname }}_pcap.zip"


- name: Transfer logs to aggregation server
  ansible.windows.win_powershell:
    script: |
      scp -i "C:\Users\{{ ansible_user }}\.ssh\id_ed25519_win" "C:\Export-EventLogs\{{ hostname }}_logs.zip" debian@10.0.1.12:"/home/debian/dataset/{{ hostname }}/logs/{{ hostname }}_logs.zip"


- name: Transfer pcaps to aggregation server
  ansible.windows.win_powershell:
    script: |
      scp -i "C:\Users\{{ ansible_user }}\.ssh\id_ed25519_win" "C:\Export-EventLogs\{{ hostname }}_pcap.zip" debian@10.0.1.12:"/home/debian/dataset/{{ hostname }}/network/{{ hostname }}_pcap.zip"


#scp -i C:\Users\TestAdmin\.ssh\id_ed25519_win C:\Export-EventLogs\IT-Win-PC-1_logs.zip debian@10.0.1.12:/home/debian/dataset/IT-Win-PC-1/IT-Win-PC-1_logs.zip

# - name: Transfer logfiles file from ServerA to ServerB
#   synchronize:
#     src: "C:\\Export-EventLogs\\{{ hostname }}_logs.zip" # /path/on/server_a # 
#     dest: /home/debian/dataset/{{ hostname }}/{{ hostname }}_logs.zip  # /path/on/server_b  # 
#     mode: pull
#     private_key: ~/.ssh/id_ed25519_win
#   delegate_to: aggregation_server  # server b


# - name: Transfer pcap file from ServerA to ServerB
#   synchronize:
#     src: "C:\\Export-EventLogs\\{{ hostname }}_pcap.zip"
#     dest: /home/debian/dataset/{{ hostname }}/{{ hostname }}_pcap.zip
#     mode: pull
#     private_key: ~/.ssh/id_ed25519_win    
#   delegate_to: aggregation_server  # server b